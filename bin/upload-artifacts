#!/bin/bash -ex

APP_ROOT=$(git rev-parse --show-toplevel)
DATA_ROOT="${APP_ROOT}/data"

function upload() {
  TAG=$1
  INPUT=$2

  RESOURCE="${TAG}/$(basename $INPUT)"
  BUCKET=maps-eotw
  ENDPOINT=https://s3.us-west-004.backblazeb2.com
  aws s3 --endpoint=$ENDPOINT cp "${DATA_ROOT}/${INPUT}" "s3://${BUCKET}/${RESOURCE}"
}

function usage() {
cat << EOF
usage: $0 <area> <release-tag>
e.g.: $0 Seattle seattle-latest
e.g.: $0 planet-v1.18 planet-v1.18
EOF
}

TAG=$1
if [ -z "${TAG}" ]; then
  echo "missing tag"
  usage
  exit 1
fi

# These files depend on the area of the map
AREA=$2
if [ -z "${AREA}" ]; then
  echo "missing area"
  usage
  exit 1
fi

upload "${TAG}" "${AREA}.graph.obj"  
upload "${TAG}" "${AREA}.osm.pbf"
upload "${TAG}" "${AREA}.valhalla.tar"
upload "${TAG}" "${AREA}.gtfs.tar"
upload "${TAG}" "${AREA}.pelias.json"
upload "${TAG}" "${AREA}.elasticsearch.tar"
upload "${TAG}" "${AREA}.mbtiles"
upload "${TAG}" "${AREA}.placeholder.tar"

# These files are generic across all areas
upload "${TAG}" fonts.tar
upload "${TAG}" sprite.tar                                      
upload "${TAG}" natural_earth.mbtiles      
